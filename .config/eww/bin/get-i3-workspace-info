#!/bin/python3
from i3ipc import Connection
from json import dumps
import sys

#Gets information from the i3ipc and outputs it in a json format
#MAX_FOCUSED_LENGTH = 20

i3 = Connection()
workspaces = i3.get_workspaces()

output = {}

focused = i3.get_tree().find_focused()
#truncate the name if it is too long
#commented out because im using window instances instead of titles. (these c
#new_focused_name = ('..' + focused.name[MAX_FOCUSED_LENGTH:]) if len(focused.name) > MAX_FOCUSED_LENGTH else focused.name
new_focused_name = focused.window_instance
output["focused_window"] = new_focused_name

workspace_info = []
for workspace in workspaces:
    if workspace.focused == True:
        output["focused_workspace"] = workspace.name
    workspace_output = {
        "name": workspace.name,
        "focused": workspace.focused
    }
    workspace_info.append(workspace_output)

#For eww. convert array into a single string of eww code
def convert_to_eww(workspace):
    return f'(_workspace_item :name \'{workspace["name"]}\' :focused \'{str(workspace["focused"]).lower()}\')'

joined_workspaces = ''.join([convert_to_eww(workspace) for workspace in workspace_info])
outer = f'(box {joined_workspaces})'
output["workspaces"] = outer


#Export data
sys.stdout.write(dumps(output))
